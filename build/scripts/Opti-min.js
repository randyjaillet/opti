class Opti{settings;i;s;l;o;groupCount;ogTabindex;constructor($s,options){"string"==typeof(options=options||{})&&(options=JSON.parse(options)),this.settings=$.extend({shortModeThreshold:7,useFirstOptionAsPlaceholder:!1,classes:"",showClearAll:!0,firstOptDefault:!0},options);let alreadyInstantiatedIndex=-1;if($.each(window.optis,((i,v)=>{v&&v.s.is($s)&&(alreadyInstantiatedIndex=$.inArray(v,window.optis))})),alreadyInstantiatedIndex>=0)window.optis[alreadyInstantiatedIndex].destroy(!0),window.optis[alreadyInstantiatedIndex]=this;else{const firstUndefinedIndex=window.optis.findIndex((element=>void 0===element));firstUndefinedIndex>=0?window.optis[firstUndefinedIndex]=this:window.optis.push(this)}this.i=$(window.optis).index(this),this.s=$s,this.l=$(`label[for="${this.s.attr("id")}"]`).add(this.s.closest("label")),this.groupCount=1;const self=this;this.o=$("<div/>").addClass("opti").attr("id",self.s.attr("id")?`${self.s.attr("id")}-opti`:null).attr("data-theme",self.s.data("theme")).attr("data-scheme",self.s.data("scheme")).addClass(self.settings.classes);const $oSurface=$("<a/>").attr("href","#").addClass("surface").appendTo(this.o),$oSurfText=$("<div/>").addClass("texts").appendTo($oSurface),$oSurfTextPH=($("<span/>").addClass("text-op").appendTo($oSurfText),$("<span/>").addClass("text-ph").appendTo($oSurfText)),$oSurfTextUL=$("<ul/>").appendTo($oSurfText),$oSurfIconEx=$('<svg class="icon-ex-surf" height="20px" width="20px" stroke-miterlimit="10" style="fill-rule:nonzero;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round;" version="1.1" viewBox="6.5 6.5 20 20" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" stroke="#000000" stroke-width="1"><path d="M20,13 L13,20" fill="none" opacity="1" stroke-linecap="round" stroke-linejoin="round"/><path d="M13,13 L20,20" fill="none" opacity="1" stroke-linecap="round" stroke-linejoin="round"/></svg>'),$oSurfIconChevs=$('<svg xmlns="http://www.w3.org/2000/svg" class="icon-chevs" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="m7 15 5 5 5-5"/><path d="m7 9 5-5 5 5"/></svg>'),$oSurfIconBan=$('<svg xmlns="http://www.w3.org/2000/svg" class="icon-ban" width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-ban"><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg>'),$oDropdown=$("<div/>").addClass("dropdown").appendTo(this.o),$oSearch=$("<div/>").addClass("search").appendTo($oDropdown),$oSearchInput=($('<svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="1" stroke-linecap="round" stroke-linejoin="round"><path d="M21 6H3"/><path d="M10 12H3"/><path d="M10 18H3"/><circle cx="17" cy="15" r="3"/><path d="m21 19-1.9-1.9"/></svg>').appendTo($oSearch),$("<input/>").attr("type","text").attr("tabindex",-1).attr("autocomplete","off").appendTo($oSearch)),$oList=$("<section/>").addClass("list").appendTo($oDropdown);this.settings.showClearAll&&$oSurfIconEx.appendTo($oSurface),$oSurfIconChevs.appendTo($oSurface),$oSurfIconBan.appendTo($oSurface),this.s.is("[disabled]")&&this.o.attr("disabled",this.s.attr("disabled")),this.s.is("[multiple]")&&this.o.attr("multiple",this.s.attr("multiple")),this.s.is("[tabindex]")&&$oSurface.attr("tabindex",this.s.attr("tabindex"));let oIsDisabled=this.o.is("[disabled=disabled]"),oIsMultiple=this.o.is("[multiple=multiple]");this.ogTabindex=this.s.attr("tabindex"),this.s.find("optgroup").attr("data-groupindex",(()=>self.groupCount++)),Opti.#convertOptsAndGroups.bind(self,this.s)().appendTo($oList);let $oOpts=$("span",$oList);const ufoapSetting=this.settings.useFirstOptionAsPlaceholder,ufoapSettingType=typeof ufoapSetting,$firstOpt=$oOpts.not("[disabled=disabled]").first(),firstOptVal=$firstOpt.attr("data-value"),ufoapBool=!0===ufoapSetting||"string"==ufoapSettingType&&firstOptVal===ufoapSetting;this.placeholderTextEnabled=ufoapBool,ufoapBool&&(this.placeholderText=$firstOpt.text(),this.placeholderValue=$firstOpt.attr("data-value"),$firstOpt.remove(),$oSurfTextPH.text(this.placeholderText));const $initiallySelectedOpts=$oOpts.filter("[selected=selected]").not("[disabled=disabled]");if($initiallySelectedOpts.length)this.chooseOption($initiallySelectedOpts,!1,!0);else if(ufoapBool)this.#choosePlaceholderOption(),this.o.addClass("zerostate");else if(this.settings.firstOptDefault&&!oIsMultiple){const $firstChoosableListItem=this.o.find(".list span:not([disabled=disabled])").first();this.chooseOption($firstChoosableListItem,!1,!0)}else self.handleZeroStateText();this.s.addClass("opti-hidden").data("originalTabindex",this.s.prop("tabindex")).attr("tabindex","-1").after(this.o),this.o.attr("data-opti-index",this.i),this.isInShortMode=$("span",$oList).length<this.settings.shortModeThreshold,this.isInShortMode&&$oSearch.hide(),oIsDisabled&&$oSurface.attr("tabindex","-1"),$(self.#orientDropdown()),$(window).on("resize",(()=>{self.#orientDropdown()})),this.l.length&&this.l.on("click",(e=>{e.preventDefault();const inOpti=$(e.target).closest(".opti").length;oIsDisabled=self.o.is("[disabled=disabled]"),!oIsDisabled&!inOpti&&self.showMenu()})),this.s.on({focus:()=>{$oSurface.trigger("focus")},change:(e,ignore)=>{if(!ignore){const sVal=self.s.val(),$lis=$("span",$oList),$liTargetsToUnchoose=$();$lis.each((function(i,v){-1===$.inArray($(v).attr("data-value"),sVal)&&($liTargetsToUnchoose=$liTargetsToUnchoose.add($(v)))})),self.unchooseOption($liTargetsToUnchoose,!1,!1,!1,!0),self.chooseOption(sVal)}}}),$oSurface.on("click",(e=>{e.preventDefault(),oIsDisabled=self.o.is("[disabled=disabled]"),oIsDisabled||(self.o.is(".activated")?self.hideMenu():self.showMenu())})),this.o.on({focusin:()=>{self.o.addClass("focus-in")},focusout:()=>{self.o.removeClass("focus-in")}}),$oSurface.on({keypress:e=>{const oIsActivated=self.o.hasClass("activated");oIsDisabled=self.o.is("[disabled=disabled]"),oIsDisabled||(32==e.which?(e.preventDefault(),oIsActivated?self.hideMenu(!1):self.showMenu()):($oSearchInput.val(null).trigger("change"),self.showMenu(!0)))},keydown:e=>{$oOpts=$("span",$oList),oIsDisabled=self.o.is("[disabled=disabled]"),oIsMultiple=self.o.is("[multiple=multiple]");const isCurrentlyActivated=self.o.hasClass("activated"),$selectableOpts=$oOpts.not(".opti-hidden,[disabled=disabled]"),$removableOpts=$oOpts.filter(".selected"),$currentlySelected=$selectableOpts.filter(".selected").first(),CSIndex=$selectableOpts.index($currentlySelected),$CSPrevAll=$currentlySelected.length?$selectableOpts.slice(0,CSIndex):$selectableOpts,$CSNextAll=$currentlySelected.length?$selectableOpts.slice(CSIndex+1):$selectableOpts,$currentlyFocused=$selectableOpts.filter(".fakefocus"),CFIndex=$selectableOpts.index($currentlyFocused),$CFPrevAll=$currentlyFocused.length?$selectableOpts.slice(0,CFIndex):$selectableOpts,$CFNextAll=$currentlyFocused.length?$selectableOpts.slice(CFIndex+1):$selectableOpts;switch(e.which){case 27:e.preventDefault(),isCurrentlyActivated&&self.hideMenu();break;case 9:!$currentlyFocused.length||$currentlyFocused.is($currentlySelected)||oIsDisabled||!isCurrentlyActivated||oIsMultiple||self.chooseOption($currentlyFocused),self.hideMenu();break;case 13:if(e.preventDefault(),!oIsDisabled)if(isCurrentlyActivated){if($currentlyFocused.length){$currentlyFocused.length&&self.#selectionAction($currentlyFocused);break}}else self.showMenu();break;case 8:e.preventDefault(),$removableOpts.length&&!oIsDisabled&&self.unchooseOption($removableOpts.last());break;case 38:if(isCurrentlyActivated){e.preventDefault();let $t=$CFPrevAll.last();$CFPrevAll.length&&$currentlyFocused.length||($t=$selectableOpts.last()),self.#fakeFocusOn($t)}else if(!oIsMultiple){e.preventDefault();const shouldWeFade=!self.isBlankOrPlaceholder(),$optionTarget=$CSPrevAll.length?$CSPrevAll.last():$selectableOpts.last();self.chooseOption($optionTarget,!1,shouldWeFade)}break;case 40:if(isCurrentlyActivated){e.preventDefault();let $t=$CFNextAll.first();$CFNextAll.length&&$currentlyFocused.length||($t=$selectableOpts.first()),self.#fakeFocusOn($t)}else if(!oIsMultiple){e.preventDefault();const shouldWeFade=!self.isBlankOrPlaceholder(),$optionTarget=$CSNextAll.length?$CSNextAll.first():$selectableOpts.first();self.chooseOption($optionTarget,!1,shouldWeFade)}break;case 36:if(isCurrentlyActivated){e.preventDefault();const $t=$selectableOpts.first();self.#fakeFocusOn($t)}break;case 35:if(isCurrentlyActivated){e.preventDefault();const $t=$selectableOpts.last();self.#fakeFocusOn($t)}}}}),$oSearchInput.on({keydown:e=>{$oOpts=$("span",$oList),oIsDisabled=self.o.is("[disabled=disabled]"),oIsMultiple=self.o.is("[multiple=multiple]");const isCurrentlyActivated=self.o.hasClass("activated"),searchIsBlank=""===this.o.find(".search input").val(),$selectableOpts=$oOpts.not(".opti-hidden,[disabled=disabled]"),$removableOpts=$oOpts.filter(".selected"),$currentlySelected=$selectableOpts.filter(".selected").first(),CSIndex=$selectableOpts.index($currentlySelected),$currentlyFocused=($currentlySelected.length&&$selectableOpts.slice(0,CSIndex),$currentlySelected.length&&$selectableOpts.slice(CSIndex+1),$selectableOpts.filter(".fakefocus")),CFIndex=$selectableOpts.index($currentlyFocused),$CFPrevAll=$currentlyFocused.length?$selectableOpts.slice(0,CFIndex):$selectableOpts,$CFNextAll=$currentlyFocused.length?$selectableOpts.slice(CFIndex+1):$selectableOpts;switch(e.which){case 9:!$currentlyFocused.length||$currentlyFocused.is($currentlySelected)||oIsDisabled||!isCurrentlyActivated||oIsMultiple||self.chooseOption($currentlyFocused),self.hideMenu();break;case 38:if(e.preventDefault(),$selectableOpts.length){let $t=$CFPrevAll.last();$t.length||($t=$selectableOpts.last()),self.#fakeFocusOn($t)}break;case 40:if(e.preventDefault(),$selectableOpts.length){let $t=$CFNextAll.first();$t.length||($t=$selectableOpts.first()),self.#fakeFocusOn($t)}break;case 36:e.preventDefault(),$selectableOpts.length&&self.#fakeFocusOn($selectableOpts.first());break;case 35:e.preventDefault(),$selectableOpts.length&&self.#fakeFocusOn($selectableOpts.last());break;case 27:e.preventDefault(),self.o.hasClass("activated")&&self.hideMenu();break;case 8:searchIsBlank&&(e.preventDefault(),$removableOpts.length&&self.unchooseOption($removableOpts.last()));break;case 13:e.preventDefault(),$currentlyFocused.length&&self.#selectionAction($currentlyFocused)}},"input change":e=>{this.o.find(".search input").val()?self.#searchMenu(this.o.find(".search input").val()):self.#unsearchMenu()}}),$oList.on("click","span",(e=>{$(e.target).is(":not(span)")&&(e.target=$(e.target).closest("span").get(0)),self.#selectionAction($(e.target))})),$oSurfTextUL.on("click",".tag",(e=>{e.preventDefault(),e.stopPropagation();const $tag=$(e.target).is(".tag")?$(e.target):$(e.target).closest(".tag");!($tag.is("[disabled=disabled]")||self.o.is("[disabled=disabled]"))&&self.unchooseOption($tag.attr("data-value"),!1,!1,$oSurface)})),$oSurfIconEx.on({click:e=>{e.preventDefault(),e.stopPropagation();const oIsNotDisabled=self.o.is(":not([disabled=disabled])"),$targets=self.o.find(".list .selected").not("[disabled=disabled]");oIsNotDisabled&&self.unchooseOption($targets,!1,!1,$oSurface)},mouseenter:e=>{this.o.addClass("highlightRemovables")},mouseleave:e=>{this.o.removeClass("highlightRemovables")}}),$(document).on("click.opti-"+self.i,(e=>{const clickIsInOpti=$(e.target).closest(self.o).length;$(e.target).closest(`[for=${self.s.attr("id")}]`).add($(e.target).closest("label").has(self.s)).length||clickIsInOpti||self.hideMenu(!1)}));this.observer=new MutationObserver(((mutationList,observer)=>{for(const mutation of mutationList)if("attributes"==mutation.type){if($(mutation.target).is("select")){if("disabled"==mutation.attributeName&&(self.s.attr(mutation.attributeName)!=mutation.attributeName?self.o.removeAttr(mutation.attributeName):self.o.attr(mutation.attributeName,self.s.attr(mutation.attributeName))),"multiple"==mutation.attributeName){const currentVal=self.s.val(),targetVal=$.isArray(currentVal)?currentVal[0]:currentVal,callbackArgs={$targetOpt:self.o.find(`.list span[data-value="${targetVal}"]`),$nonDisabledOpts:self.o.find(".list span:not([disabled=disabled])")};self.o.find(".list span.selected").length?self.unchooseOption(self.o.find(".list span.selected"),Opti.#unchooseAfter.bind(self,callbackArgs)):Opti.#unchooseAfter.bind(self,callbackArgs)()}}else if($(mutation.target).is("option"))if("value"==mutation.attributeName){const $correspondingListItem=self.o.find(`.list span[data-value="${mutation.oldValue}"]`),$correspondingTag=self.o.find(`.surface .tag[data-value="${mutation.oldValue}"]`);$correspondingListItem.add($correspondingTag).attr("data-value",$(mutation.target).val())}else if("disabled"==mutation.attributeName){const newVal=$(mutation.target).attr("disabled")||!1,$correspondingListItem=self.o.find(`.list span[data-value="${$(mutation.target).val()}"]`);"disabled"==newVal?($correspondingListItem.attr("disabled","disabled"),$correspondingListItem.is(".selected")&&self.unchooseOption($correspondingListItem,(()=>{self.isBlank()&&!self.placeholderTextEnabled&&self.settings.firstOptDefault?self.chooseOption(self.o.find(".list span:not([disabled=disabled])").first()):self.handleZeroStateText()}),!1,!1,!0)):$correspondingListItem.removeAttr("disabled")}}else"childList"==mutation.type&&(mutation.addedNodes.length?(mutation.addedNodes.forEach((function(currentValue,currentIndex,listObj){const $list=self.o.find(".list"),$addedNode=$(currentValue),$newTree=Opti.#convertOptsAndGroups.bind(self,$addedNode)(),addedNodeIsOptgroup=$addedNode.is("optgroup"),$addedNodeParent=$addedNode.parent(),optAddedToOptgroup=$addedNodeParent.is("optgroup");if(addedNodeIsOptgroup){$addedNode.attr("data-groupindex",(()=>self.groupCount++));const $sValidAll=self.s.children(`option:not([value="${self.placeholderValue}"]), optgroup`),$oValidAll=$list.children("span, section"),ind=$sValidAll.index($addedNode)-1;if(-1==ind)$newTree.prependTo($list);else{const $listItemAtInd=$oValidAll.eq(ind);$newTree.insertAfter($listItemAtInd)}}else if($addedNode.is(":first-child"))if(optAddedToOptgroup){const opGrpInd=self.s.find("optgroup").index($addedNodeParent),$grp=$list.children("section").eq(opGrpInd);$newTree.insertAfter($grp.children("h5").first())}else $newTree.prependTo($list);else{const $sValidOpts=self.s.find(`option:not([value="${self.placeholderValue}"])`),$oValidOpts=$list.find("span"),ind=$sValidOpts.index($addedNode)-1,$spanAtInd=$oValidOpts.eq(ind);-1==ind?$newTree.insertBefore($oValidOpts.first()):optAddedToOptgroup?$newTree.insertAfter($spanAtInd):$spanAtInd.next().is("section:not(:has(span))")?$newTree.insertAfter($spanAtInd.nextUntil("span","section:not(:has(span))").last()):$spanAtInd.is("section:not(.list) > :last-child")?$newTree.insertAfter($spanAtInd.parent("section")):$newTree.insertAfter($spanAtInd)}})),self.isInShortMode=$("span",$oList).length<self.settings.shortModeThreshold,self.isInShortMode&&$oSearch.hide()):mutation.removedNodes.length&&(mutation.removedNodes.forEach((currentValue=>{const removedNodeIsOpt=$(currentValue).is("option"),removedNodeIsOptgroup=$(currentValue).is("optgroup"),$selectedOptsToUnchoose=$(currentValue).find(":selected").addBack(":selected");let $nukeTarget;if(removedNodeIsOpt)$nukeTarget=self.o.find(`.list [data-value="${$(currentValue).val()}"]`);else if(removedNodeIsOptgroup){const opGrpInd=$(currentValue).attr("data-groupindex");$nukeTarget=self.o.find(`.list section[data-groupindex=${opGrpInd}]`)}if($selectedOptsToUnchoose.length){let $listItemTargets=$();$selectedOptsToUnchoose.each((function(i,v){$listItemTargets=$listItemTargets.add(`span[data-value="${$(v).val()}"]`,self.o.find(".list"))})),self.unchooseOption($listItemTargets,!1,!0)}$nukeTarget.remove()})),self.isInShortMode=$("span",$oList).length<self.settings.shortModeThreshold,self.isInShortMode||$oSearch.show()))})),this.observer.observe(this.s.get(0),{attributes:!0,childList:!0,subtree:!0,attributeOldValue:!0})}showMenu(focusOnSearch=!this.isInShortMode){if(this.o.is(":not(.activated)")){const $oSurface=$(".surface",this.o),$oSearch=$(".search",this.o),$oSearchInput=$oSearch.find("input"),$focusTarget=focusOnSearch?$oSearchInput:$oSurface;this.o.addClass("activated"),focusOnSearch&&$($oSearch).filter(":hidden").show(),$focusTarget.trigger("focus"),this.o.trigger("optishow")}}hideMenu(focusOnSurface=!0){if(this.o.is(".activated")){const $oSearch=$(".search",this.o),$oSearchInput=$oSearch.find("input"),$oSurface=$(".surface",this.o),$currentlyFocused=$(".fakefocus",this.o);this.o.removeClass("activated"),$currentlyFocused.removeClass("fakefocus"),focusOnSurface&&$oSurface.trigger("focus"),this.isInShortMode&&$oSearch.is(":visible")&&$oSearch.hide(),this.o.trigger("optihide"),this.o.find(".dropdown").on("transitionend",(function(e){"left"==e.originalEvent.propertyName&&($(e.target).off("transitionend"),$oSearchInput.val(null).trigger("change"))}))}}#orientDropdown(){const $s=$(".surface",this.o),$dd=$(".dropdown",this.o);$s.offset().top+$s.outerHeight()+$dd.outerHeight()>$("body").height()&&$s.offset().top>$dd.outerHeight()?this.o.addClass("flip-v"):this.o.removeClass("flip-v")}#searchMenu(string){const $spans=$(".list span",this.o),filterSelector=":containsis("+string+")",$matches=$spans.filter(filterSelector);this.#unsearchMenu(),$spans.filter(".fakefocus").removeClass("fakefocus"),$spans.not($matches).add($(".list section",this.o).not($matches.parents())).addClass("opti-hidden");const $focusableSpans=$spans.not(".opti-hidden,[disabled=disabled]");this.o.find(".search input").is(":focus")&&$focusableSpans.length&&$focusableSpans.first().addClass("fakefocus")}#unsearchMenu(){this.o.find(".list").find(".opti-hidden").removeClass("opti-hidden")}chooseOption(vals,setFocus,noFade=!1){const self=this,$pht=this.o.find(".surface .texts .text-ph"),$txt=this.o.find(".surface .texts .text-op"),wasPlaceholder=this.isPlaceholder();let $options=$();if($.isArray(vals))$.each(vals,((ind,currVal)=>{const $target=self.o.find(`.list [data-value="${currVal}"]`);$options=$options.add($target)}));else if("string"==typeof vals){const $target=self.o.find(`.list [data-value="${vals}"]`);$options=$options.add($target)}else"object"==typeof vals&&vals instanceof jQuery&&($options=$options.add(vals));const $option=$options.first();if($options.length){Opti.#unchoosePlaceholderOption.bind(self)();const wasBlank=this.isBlank();self.isPlaceholder();this.s.is("[multiple=multiple]")?$options.each(((i,v)=>{self.s.val(((i2,v2)=>(v2.push($(v).attr("data-value")),v2)))})):(self.s.val($option.attr("data-value")),this.o.find(".list span.selected").removeClass("selected"),$option.addClass("selected"),this.hideMenu(setFocus));const fadeOutCallbackArgs={$options:$options,setFocus:setFocus,wasPlaceholder:wasPlaceholder};wasPlaceholder&&!noFade?self.#fadeOut.bind(self)($pht,Opti.#chooseAfter.bind(self,fadeOutCallbackArgs,!0),!1):wasBlank||noFade||self.o.is("[multiple=multiple]")?Opti.#chooseAfter.bind(self)(fadeOutCallbackArgs,!0):self.#fadeOut.bind(self)($txt,Opti.#chooseAfter.bind(self,fadeOutCallbackArgs),!1)}}static#chooseAfter(args,removeZeroState){const self=this,$option=args.$options.first();if(removeZeroState&&self.o.removeClass("zerostate"),args.$options.each(((i,v)=>{if(!$(v).is(".selected")){let $newTag=$("<li/>").addClass("tag initial").attr("data-value",$(v).attr("data-value")).append('<svg class="icon-ex" height="7px" width="7px" stroke-miterlimit="10" style="fill-rule:nonzero;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round;" version="1.1" viewBox="0 0 7 7" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" stroke="#000000" stroke-width="1"><path d="M6.5 0.5L0.5 6.5" fill="none" opacity="1" stroke-linecap="round" stroke-linejoin="round"/><path d="M0.5 0.5L6.5 6.5" fill="none" opacity="1" stroke-linecap="round" stroke-linejoin="round"/></svg>').append($("<span/>").addClass("tag-text").text($(v).text())),valPosition=$.inArray($(v).attr("data-value"),self.s.val());args.wasPlaceholder&&(valPosition=0);if(0==valPosition)$newTag.prependTo(self.o.find(".surface ul"));else{const $targTag=self.o.find(".surface .tag").eq(valPosition-1);$newTag.insertAfter($targTag)}$newTag.outerHeight();$newTag.removeClass("initial")}})),self.o.is("[multiple=multiple]")){if(args.$options.addClass("selected"),self.o.find(".search input").val(null).trigger("change"),args.setFocus){const $oSearch=self.o.find(".search"),$oSearchInput=$oSearch.find("input"),$oSurf=self.o.find(".surface");(self.isInShortMode&&$oSearch.is(":hidden")?$oSurf:$oSearchInput).trigger("focus")}}else{const $optParent=$option.parent();self.o.find(".surface .text-op").text($option.text()),$optParent.is("section:not(.list)")&&self.o.find(".surface .text-op").prepend(`<span class="text-grp">${$optParent.find("h5").text()}</span>`)}self.s.add(self.o).trigger("change",!0)}unchooseOption(vals,callback,callbackArgs,focusTarget,dontUpdateSelect,noFade=!1){const self=this,$oSurface=this.o.find(".surface"),$oList=this.o.find(".list"),$oSearchInput=this.o.find(".search input"),oIsMulti=this.o.is("[multiple=multiple]"),sIsMulti=this.s.is("[multiple=multiple]");let $options=$();$.isArray(vals)?$.each(vals,((_ind,currVal)=>{const $target=$("[data-value='"+currVal+"']",$oList);$options=$options.add($target)})):"string"==typeof vals?$options=$oList.find(`[data-value="${vals}"]`):"object"==typeof vals&&vals instanceof jQuery&&($options=$options.add(vals)),dontUpdateSelect||($options=$options.filter(".selected")),$options.removeClass("selected"),dontUpdateSelect||(sIsMulti?self.s.val(((i,v)=>{let newVal=v;return $options.each(((i2,v2)=>{newVal.splice($.inArray($(v2).attr("data-value"),v),1)})),newVal})):self.s.val(""),this.s.trigger("change",!0));let $targetTags=$();$options.each(((i,v)=>{$targetTags=$targetTags.add($(`.surface ul .tag[data-value="${$(v).attr("data-value")}"]`,self.o))})),noFade||!$targetTags.length&&oIsMulti?($targetTags.remove(),"function"==typeof callback&&callback(self,callbackArgs),self.handleZeroStateText()):oIsMulti&&$targetTags.length?Opti.#fadeOutTag.bind(self,$targetTags,callback,!0,callbackArgs)():self.#fadeOut.bind(self,$oSurface.find(".text-op"),callback,!1)(),this.o.trigger("change"),$oSearchInput.val()&&$oSearchInput.val("").trigger("change"),focusTarget instanceof jQuery&&focusTarget.trigger("focus")}static#unchooseAfter(args){const self=this;"multiple"!=self.s.attr("multiple")?self.o.removeAttr("multiple"):self.o.attr("multiple","multiple"),args.$targetOpt.length?self.chooseOption(args.$targetOpt,!1,!0):self.isBlank()&&!self.placeholderTextEnabled&&self.settings.firstOptDefault&&args.$nonDisabledOpts.length?self.chooseOption(args.$nonDisabledOpts.first(),!1):self.handleZeroStateText()}#choosePlaceholderOption(){this.placeholderTextEnabled&&(this.o.is("[multiple=multiple]")?this.s.val([this.placeholderValue]):this.s.val(this.placeholderValue))}static#unchoosePlaceholderOption(){if(this.isPlaceholder())if($.isArray(this.s.val())){const needle=this.placeholderValue;this.s.val(((i,v)=>!!$.isArray(v)&&v.toSpliced($.inArray(needle,v),1)))}else"string"==typeof this.s.val()&&this.s.val("foo")}handleZeroStateText(){this.isBlankOrPlaceholder()?(this.o.addClass("zerostate"),this.placeholderTextEnabled?this.#choosePlaceholderOption.bind(this)():this.o.find(".surface .text-op").text(null)):this.o.removeClass("zerostate")}#fadeOut($t,callback,removeTarget){const self=this;window.getComputedStyle($t.get(0)).top,$t.css({opacity:1,transform:"translate(0px, 0px)"}),window.getComputedStyle($t.get(0)).top,$t.addClass("fadingOut"),window.getComputedStyle($t.get(0)).top,$t.on("transitionend",(function(e){window.getComputedStyle($t.get(0)).top,"opacity"==e.originalEvent.propertyName&&(window.getComputedStyle($t.get(0)).top,removeTarget?$t.remove():($t.removeClass("fadingOut"),$t.removeAttr("style")),self.handleZeroStateText(),"function"==typeof callback&&callback(),$t.off("transitionend"))}))}static#fadeOutTag($t,callback){const self=this;$t.css({width:function(){return $(this).outerWidth()},"flex-basis":function(){return $(this).outerWidth()},opacity:1,transform:"translate(0px, 0px)"});$t.outerWidth();$t.addClass("fadingOut");$t.outerWidth();$t.on("transitionend",(function(e){"opacity"==e.originalEvent.propertyName&&($t.remove(),self.handleZeroStateText(),"function"==typeof callback&&callback())}))}#fakeFocusOn($t){$t.length&&(this.o.find(".list .fakefocus").removeClass("fakefocus"),$t.addClass("fakefocus"),this.#scrollOptionIntoView($t))}#scrollOptionIntoView($option){const $list=this.o.find(".list"),$prevH5=$option.prev("h5"),offsetTop=($prevH5.length?$prevH5:$option).position().top,offsetBot=$option.position().top+$option.outerHeight(),isAboveFold=offsetTop<0,isBelowFold=offsetBot>$list.innerHeight();isAboveFold?$list.scrollTop($list.scrollTop()+offsetTop):isBelowFold&&$list.scrollTop($list.scrollTop()+offsetBot-$list.innerHeight())}isBlankOrPlaceholder(){return this.isBlank()||this.isPlaceholder()}isBlank(){const val=this.s.val(),valIsFalseOrNull=null===val||!1===val,valIsString="string"==typeof val,valIsArray=$.isArray(val);return valIsFalseOrNull||valIsString&&!val||valIsArray&&!val.length}isPlaceholder(){const val=this.s.val(),valIsString="string"==typeof val,valIsArray=$.isArray(val),phv=this.placeholderValue;return this.placeholderTextEnabled&&(valIsArray&&1==val.length&&$.inArray(phv,val)>=0||valIsString&&phv==val)}static#convertOptsAndGroups($tree){const isSelect=$tree.is("select");let $newTree=$tree.clone().wrap("<div/>").parent();return isSelect&&$newTree.children("select").contents().unwrap(),$newTree.find("optgroup").replaceWith((function(){const lab=$(this).attr("label"),contents=$(this).html();return $("<section/>").attr("data-groupindex",$(this).attr("data-groupindex")).html(contents).prepend(`<h5>${lab}</h5>`)})),$newTree.find("option").replaceWith((function(){const sel=$(this).attr("selected")||!1,dis=$(this).attr("disabled")||!1,val=$(this).val(),contents=$(this).html();return $("<span/>").attr("selected",sel).attr("disabled",dis).attr("data-value",val).html(contents).prepend($('<svg xmlns="http://www.w3.org/2000/svg" class="icon-arrow" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M5 12h14"/><path d="m12 5 7 7-7 7"/></svg>')).append($('<svg xmlns="http://www.w3.org/2000/svg" class="icon-tick" width="15" height="15" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><path d="M20 6 9 17l-5-5"/></svg>')).append($('<svg xmlns="http://www.w3.org/2000/svg" class="icon-ban" width="15" height="12" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="1.7" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><path d="m4.9 4.9 14.2 14.2"/></svg>'))})),$newTree.contents()}#selectionAction($t){$t.is(":not(span)")&&($t=$t.closest("span"));const anythingIsDisabled=this.o.add($t).is("[disabled=disabled]"),optIsSelected=$t.is(".selected"),oIsMultiple=this.o.is("[multiple=multiple]");if(!anythingIsDisabled)if(optIsSelected)if(oIsMultiple){const $focusTarget=this.isInShortMode?this.o.find(".surface"):this.o.find(".search input");this.unchooseOption($t,$focusTarget)}else this.hideMenu();else this.chooseOption($t,!0)}destroy(preserveSlotInWindowArray){preserveSlotInWindowArray=preserveSlotInWindowArray||!1,this.s.add(this.l).off("focus.opti change click.opti"),this.o.remove(),this.s.removeClass("opti-hidden").attr("tabindex",this.s.data("originalTabindex")),$(document).off(`click.opti-${this.i}`),this.observer.disconnect(),preserveSlotInWindowArray?window.optis[this.i]=void 0:window.optis.splice(this.i,1)}}